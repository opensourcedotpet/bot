<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Discord Message Stream</title>
    <link
      href="https://cdn.jsdelivr.net/gh/uchks/ggcdn@master/ggsans.css"
      rel="stylesheet"
    />
    <script src="https://cdn.socket.io/4.4.1/socket.io.min.js"></script>
    <style>
      body {
        font-family: "gg sans", Arial, sans-serif;
        background-color: #f4f4f8;
        color: #333;
        margin: 0;
        padding: 20px;
      }
      h1 {
        color: #000;
        font-size: 24px;
        text-align: center;
      }
      #filter-container {
        display: flex;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 20px;
      }
      select,
      #userIdFilter {
        flex-grow: 1;
        padding: 10px;
        border-radius: 5px;
        border: 1px solid #ccc;
        font-size: 16px;
        background-color: #fff;
        margin-bottom: 20px;
      }
      #messages {
        display: flex;
        flex-direction: column-reverse; /* Display new messages on top */
        align-items: center;
      }
      .message {
        background-color: #fff;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        border-radius: 16px;
        padding: 20px;
        margin-bottom: 20px;
        display: flex;
        align-items: flex-start;
        gap: 15px;
        flex-wrap: wrap;
        width: 100%; /* Full width */
        max-width: 600px; /* Maximum width */
      }
      .avatar {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        flex-shrink: 0; /* Prevent avatar from shrinking */
      }
      .message-content {
        flex-grow: 1;
        overflow-wrap: break-word;
      }
      .attachment-image,
      .embedded-image,
      .custom-emoji,
      .sticker {
        max-height: 100px;
        width: auto;
        border-radius: 8px;
      }
      .tooltip .tooltiptext {
        visibility: hidden;
        background-color: #555; /* Darker for better visibility */
        color: #fff;
        text-align: center;
        border-radius: 6px;
        padding: 5px 10px; /* Adjust padding */
      }

      .tooltip:hover .tooltiptext {
        visibility: visible;
      }

      a {
        text-decoration: none;
      }

      pre,
      code {
        background: #f4f4f8; /* Light grey background */
        border: 1px solid #ccc; /* Add border for visibility */
        overflow-x: auto; /* Enable horizontal scrolling for wide code blocks */
      }

      @media (max-width: 768px) {
        .message {
          flex-direction: column;
          align-items: center;
        }
      }
    </style>
  </head>
  <body>
    <h1>opensource.pet</h1>
    <div id="filter-container">
      <select id="guildFilter">
        <option value="">Guild</option>
        <!-- Options will be dynamically populated -->
      </select>
      <select id="userFilter">
        <option value="">User</option>
        <!-- Options will be dynamically populated -->
      </select>
      <input type="text" id="userIdFilter" placeholder="Search by User ID" />
    </div>
    <div id="messages"></div>

    <script>
      const socket = io("http://localhost:3000");
      const messagesContainer = document.getElementById("messages");
      const guildFilter = document.getElementById("guildFilter");
      const userFilter = document.getElementById("userFilter");
      const userIdFilter = document.getElementById("userIdFilter");

      let messages = [];

      socket.on("updateFilters", function (data) {
        // You might want to pass data to updateFilters if it needs to use this data directly
        updateFilters();
        messages.unshift(data); // prepend new messages to the array
        displayMessages(); // call to update the message display
      });

      let currentPage = 0;
      const pageSize = 50; // Number of messages to load per page
      let allMessagesLoaded = false;

      window.addEventListener("scroll", () => {
        if (nearBottomOfPage() && !allMessagesLoaded) {
          currentPage++;
          loadMoreMessages(currentPage);
        }
      });

      function nearBottomOfPage() {
        return (
          window.innerHeight + window.scrollY >=
          document.body.offsetHeight - 100
        );
      }

      function loadMoreMessages(page) {
        // Assuming `messages` is a globally stored array of all messages
        const startIndex = page * pageSize;
        const endIndex = startIndex + pageSize;
        const messagesToLoad = messages.slice(startIndex, endIndex);

        if (messagesToLoad.length === 0) {
          allMessagesLoaded = true;
          return;
        }

        messagesToLoad.forEach((message) => {
          const messageElement = createMessageElement(message);
          messagesContainer.appendChild(messageElement); // Append new messages at the end
        });
      }

      guildFilter.addEventListener("change", displayFilteredMessages);
      userFilter.addEventListener("change", displayFilteredMessages);
      userIdFilter.addEventListener("input", displayFilteredMessages);

      function displayMessages() {
        messagesContainer.innerHTML = ""; // Clear the message container
        messages.forEach((message) => {
          const messageElement = createMessageElement(message);
          messagesContainer.prepend(messageElement); // Show new messages on top
        });
      }

      function formatCodeBlocks(content) {
        console.log("Original Content: ", content);
        const formattedContent = content.replace(
          /```(\w*)\n?([\s\S]*?)```/g,
          (match, lang, code) => {
            const escapedCode = escapeHTML(code);
            console.log("Code Block: ", escapedCode);
            return `<pre><code class='${
              lang || ""
            }'>${escapedCode}</code></pre>`;
          }
        );
        console.log("Formatted Content: ", formattedContent);
        return formattedContent;
      }

      function escapeHTML(code) {
        // Escaping HTML to prevent XSS and correctly display special characters
        return code
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#39;");
      }

      function createMessageElement(message) {
        const messageElement = document.createElement("div");
        messageElement.className = "message";

        // Avatar
        const avatarElement = document.createElement("img");
        avatarElement.src = message.avatar_url || "default-avatar.png";
        avatarElement.alt = "User avatar";
        avatarElement.className = "avatar";
        messageElement.appendChild(avatarElement);

        // Content container
        const contentContainer = document.createElement("div");
        contentContainer.className = "message-content";

        // Username and channel info
        const userInfoElement = document.createElement("div");
        userInfoElement.className = "message-user-info";

        const usernameElement = document.createElement("strong");
        usernameElement.textContent = message.username;
        userInfoElement.appendChild(usernameElement);

        if (message.guildName && message.channelName) {
          const channelInfoElement = document.createElement("span");
          channelInfoElement.textContent = ` (Guild: ${message.guildName}, Channel: ${message.channelName})`;
          userInfoElement.appendChild(channelInfoElement);
        }

        contentContainer.appendChild(userInfoElement);

        // New line for message text
        const textElement = document.createElement("div");
        textElement.className = "message-text";
        // Process and set the formatted content with code blocks
        textElement.innerHTML = formatCodeBlocks(message.content);
        contentContainer.appendChild(textElement);

        // Handling custom emojis and Tenor GIFs within the message content
        replaceCustomContent(textElement);

        contentContainer.appendChild(textElement);

        // Attachments
        message.attachments.forEach((attachment) => {
          const attachmentElement = document.createElement("img");
          attachmentElement.src = attachment;
          attachmentElement.className = "attachment-image";
          contentContainer.appendChild(attachmentElement);
        });

        messageElement.appendChild(contentContainer);

        // Discord message link
        const linkElement = document.createElement("a");
        linkElement.href = message.message_link;
        linkElement.textContent = "â†–";
        linkElement.target = "_blank";
        linkElement.className = "message-link";
        messageElement.appendChild(linkElement);

        return messageElement;
      }

      function replaceCustomContent(textElement) {
        textElement.innerHTML = textElement.innerHTML
          .replace(
            /<:([\w]+):(\d+)>/g,
            (match, name, id) =>
              `<img src="https://cdn.discordapp.com/emojis/${id}.png" alt="${name}" class="custom-emoji">`
          )
          .replace(
            /https:\/\/tenor\.com\/view\/([\w-]+)-(\d+)/g,
            (url) => `<img src="${url}.gif" alt="GIF" class="embedded-gif">`
          );
      }

      function displayFilteredMessages() {
        const guildValue = guildFilter.value; // This should match the exact guild names or be empty for 'no filter'
        const userValue = userFilter.value.toLowerCase();
        const userIdValue = userIdFilter.value.trim().toLowerCase();

        messagesContainer.innerHTML = ""; // Clear current messages

        const filteredMessages = messages.filter((message) => {
          const matchesGuild = !guildValue || message.guildName === guildValue;
          const matchesUser =
            !userValue || message.username.toLowerCase().includes(userValue);
          const matchesUserId =
            !userIdValue ||
            (message.userId && message.userId.includes(userIdValue));
          return matchesGuild && matchesUser && matchesUserId;
        });

        filteredMessages.forEach((message) => {
          const messageElement = createMessageElement(message);
          messagesContainer.prepend(messageElement); // Show new messages on top
        });

        // Debug to see if any messages are being filtered
        console.log("Filtered Messages:", filteredMessages.length);
      }

      function updateFilters() {
        const guildSet = new Set();
        const userSet = new Set();

        messages.forEach((message) => {
          if (message.guildName) {
            guildSet.add(message.guildName); // Make sure the guild names are correct
          }
          if (message.username) {
            userSet.add(message.username);
          }
        });

        guildFilter.innerHTML = '<option value="">Guild</option>';
        guildSet.forEach((guild) => {
          const option = document.createElement("option");
          option.textContent = guild;
          option.value = guild; // Ensure this value matches what's used in the filter
          guildFilter.appendChild(option);
        });

        userFilter.innerHTML = '<option value="">User</option>';
        userSet.forEach((user) => {
          const option = document.createElement("option");
          option.textContent = user;
          option.value = user.toLowerCase();
          userFilter.appendChild(option);
        });
      }
    </script>
  </body>
</html>
